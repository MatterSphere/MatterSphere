--------------------------------------------------------------------------------
--     This code was generated by a tool.
--
--     Changes to this file may cause incorrect behavior and will be lost if
--     the code is regenerated.
--------------------------------------------------------------------------------

DECLARE @dbname sysname = DB_NAME()
	, @sql nvarchar(max)

IF (SELECT is_trustworthy_on FROM sys.databases WHERE name = @dbname) = 0
BEGIN
	SET @sql = N'ALTER DATABASE ' + QUOTENAME(@dbname) + N' SET TRUSTWORTHY ON'
	EXEC sp_executesql @sql
END

GO

DECLARE @assembly_bits varbinary(max) = 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C01030066283B610000000000000000E00002210B010B00000A00000006000000000000CE29000000200000004000000000001000200000000200000400000000000000040000000000000000800000000200007D5900000300408500001000001000000000100000100000000000001000000000000000000000007C2900004F00000000400000B003000000000000000000000000000000000000006000000C00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E74657874000000D409000000200000000A000000020000000000000000000000000000200000602E72737263000000B00300000040000000040000000C0000000000000000000000000000400000402E72656C6F6300000C0000000060000000020000001000000000000000000000000000004000004200000000000000000000000000000000B02900000000000048000000020005003C21000040080000090000000000000000000000000000005020000080000000000000000000000000000000000000000000000000000000000000000000000093ECB641AF72CF4EE92A59615B806C49B2817CD10A41098CAE48852971913F6005FEF7F8CE29D4FC669E655E91AA7735EEF0E38FD8190C1074F4D98F95C4EC07D4E6981EDC15282114E8D6698FAF94BEBF3BC41CDB22B155A377722B6ADC416F9E219591D0A9ACF4BC4664FB4C6B59E80D8B17A850B252932363E42A4BABDA8313300100160000000100001102280E00000A0A1200280F00000A281000000A0B072A000013300100160000000100001102280E00000A0A1200281100000A281000000A0B072A6E02281200000A2D110272010000707271000070281300000A2A022A1E02281400000A2A000042534A4201000100000000000C00000076322E302E35303732370000000005006C0000004C020000237E0000B80200002403000023537472696E677300000000DC05000078000000235553005406000010000000234755494400000064060000DC01000023426C6F620000000000000002000001571D02000900000000FA25330016000001000000120000000200000001000000040000000300000014000000010000000D00000001000000010000000300000000000A00010000000000060043003C000A007D0068000600E500D3000600FC00D30006001901D30006003801D30006005101D30006006A01D30006008501D3000600A001D3000600D801B9010600EC01D3000600250205020600450205020A008E0273020600A3023C000600E0023C000E001403F5020000000001000000000001000100010010001E00000005000100010051804A000A00D02000000000960089007C000100F42000000000960098007C0002001621000000009600A700830003003221000000008618C2008800040000000100C80000000100C80000000100CD001900C2008C002100C2008C002900C2008C003100C2008C003900C2008C004100C2008C004900C2008C005100C2008C005900C20091006100C2008C006900C20096007100C20088007900C20088001100AC0242018100B80249011100C8024E018100D40249018900E7025C0191001A0361010900C20088000E0004000D0020006B003D012E00230083012E002B0068012E006300BA012E0013007D012E001B007D012E00330091012E000B0068012E003B007D012E004B007D012E005B00B10140006B003D0160006B003D0155010480000001000000F31E4B59010000009B0063020000020000000000000000000000010033000000000002000000000000000000000001005C000000000002000000000000000000000001003C00000000000000003C4D6F64756C653E004D617474657243656E747265434C522E646C6C0055736572446566696E656446756E6374696F6E73006D73636F726C69620053797374656D004F626A6563740076616C696443686172735061747465726E0053797374656D2E446174610053797374656D2E446174612E53716C54797065730053716C4461746554696D65004C6F63616C54696D65546F55544300555443546F4C6F63616C54696D650052656D6F7665496C6C6567616C584D4C43686172616374657273002E63746F72006461746500696E7075740053797374656D2E5265666C656374696F6E00417373656D626C795469746C6541747472696275746500417373656D626C794465736372697074696F6E41747472696275746500417373656D626C79436F6E66696775726174696F6E41747472696275746500417373656D626C79436F6D70616E7941747472696275746500417373656D626C7950726F6475637441747472696275746500417373656D626C79436F7079726967687441747472696275746500417373656D626C7954726164656D61726B41747472696275746500417373656D626C7943756C747572654174747269627574650053797374656D2E52756E74696D652E496E7465726F70536572766963657300436F6D56697369626C6541747472696275746500417373656D626C7956657273696F6E4174747269627574650053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300436F6D70696C6174696F6E52656C61786174696F6E734174747269627574650052756E74696D65436F6D7061746962696C697479417474726962757465004D617474657243656E747265434C52004D6963726F736F66742E53716C5365727665722E5365727665720053716C46756E6374696F6E417474726962757465004461746554696D65006F705F4578706C6963697400546F556E6976657273616C54696D65006F705F496D706C6963697400546F4C6F63616C54696D6500537472696E670049734E756C6C4F72456D7074790053797374656D2E546578742E526567756C617245787072657373696F6E73005265676578005265706C616365000000006F5B005E005C007800300039005C007800300041005C007800300044005C007800320030002D005C00750044003700460046005C00750045003000300030002D005C00750046004600460044005C007500310030003000300030002D005C0075003100300046004600460046005D000103200000000000592543C2E667A549B6B2B82C281AE0040008B77A5C561934E08902060E6E5B005E005C007800300039005C007800300041005C007800300044005C007800320030002D005C00750044003700460046005C00750045003000300030002D005C00750046004600460044005C007500310030003000300030002D005C0075003100300046004600460046005D00060001110911090400010E0E03200001042001010E0420010102042001010880A00024000004800000940000000602000000240000525341310004000001000100C77173281B5F8394A654EF6A354868580F68479287A6FAD7CFB964EE326A1D6C82EC6960EE01991F16967ACCEB7ACF718C4B41EFBECD2D133D4A532C9A574304515BC99AE4E293A2E0EFDF80998BA3AB9A1DDD9584A7B6ACC6CF9DA61137F5FE2FCB47F75310757255C2C35CBB31AF935968BE6066308FCCE13D6E67BEA9F29804010000000600011141110904200011410600011109114106070211411109040001020E0600030E0E0E0E1401000F4D617474657243656E747265434C5200000501000000000D01000846574253204C746400001F01001A436F7079726967687420C2A92046574253204C7464203230313000000801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F777301000000A42900000000000000000000BE290000002000000000000000000000000000000000000000000000B0290000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF2500200010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100100000001800008000000000000000000000000000000100010000003000008000000000000000000000000000000100000000004800000058400000540300000000000000000000540334000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000001004B59F31E000001004B59F31E3F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B004B4020000010053007400720069006E006700460069006C00650049006E0066006F00000090020000010030003000300030003000340062003000000034000900010043006F006D00700061006E0079004E0061006D00650000000000460057004200530020004C007400640000000000480010000100460069006C0065004400650073006300720069007000740069006F006E00000000004D0061007400740065007200430065006E0074007200650043004C005200000040000F000100460069006C006500560065007200730069006F006E000000000031002E0030002E0037003900320033002E00320032003800350039000000000048001400010049006E007400650072006E0061006C004E0061006D00650000004D0061007400740065007200430065006E0074007200650043004C0052002E0064006C006C00000058001A0001004C006500670061006C0043006F007000790072006900670068007400000043006F0070007900720069006700680074002000A9002000460057004200530020004C00740064002000320030003100300000005000140001004F0072006900670069006E0061006C00460069006C0065006E0061006D00650000004D0061007400740065007200430065006E0074007200650043004C0052002E0064006C006C000000400010000100500072006F0064007500630074004E0061006D006500000000004D0061007400740065007200430065006E0074007200650043004C005200000044000F000100500072006F006400750063007400560065007200730069006F006E00000031002E0030002E0037003900320033002E00320032003800350039000000000048000F00010041007300730065006D0062006C0079002000560065007200730069006F006E00000031002E0030002E0037003900320033002E003200320038003500390000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000C000000D03900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000

IF NOT EXISTS (SELECT * FROM sys.assemblies asms WHERE asms.name = N'MatterCentreCLR' and is_user_defined = 1)
BEGIN
    CREATE ASSEMBLY [MatterCentreCLR] AUTHORIZATION [dbo]
    FROM @assembly_bits
    WITH PERMISSION_SET = SAFE;
END
ELSE
BEGIN
    IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID('[dbo].[LocalTimeToUTC]'))
        DROP FUNCTION [dbo].[LocalTimeToUTC];
    IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID('[dbo].[UTCToLocalTime]'))
        DROP FUNCTION [dbo].[UTCToLocalTime];
    IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID('[dbo].[RemoveIllegalXMLCharacters]'))
        DROP FUNCTION [dbo].[RemoveIllegalXMLCharacters];

    IF (SELECT ISNULL(ASSEMBLYPROPERTY(N'MatterCentreCLR', 'PublicKey'), '')) = ''
    BEGIN
        DROP ASSEMBLY [MatterCentreCLR];

        CREATE ASSEMBLY [MatterCentreCLR] AUTHORIZATION [dbo]
        FROM @assembly_bits
        WITH PERMISSION_SET = SAFE;
    END
    ELSE IF EXISTS(SELECT 1 FROM sys.assembly_files WHERE name = N'MatterCentreCLR' AND content <> @assembly_bits)
    BEGIN
        ALTER ASSEMBLY [MatterCentreCLR]
        FROM @assembly_bits
        WITH PERMISSION_SET = SAFE;
    END
END


GO

CREATE FUNCTION [dbo].[LocalTimeToUTC] (@date [datetime])
RETURNS [datetime]
AS EXTERNAL NAME [MatterCentreCLR].[UserDefinedFunctions].[LocalTimeToUTC]

GO

CREATE FUNCTION [dbo].[UTCToLocalTime] (@date [datetime])
RETURNS [datetime]
AS EXTERNAL NAME [MatterCentreCLR].[UserDefinedFunctions].[UTCToLocalTime]

GO

CREATE FUNCTION [dbo].[RemoveIllegalXMLCharacters] (@input [nvarchar](max))
RETURNS [nvarchar](max)
AS EXTERNAL NAME [MatterCentreCLR].[UserDefinedFunctions].[RemoveIllegalXMLCharacters]

GO
GRANT EXECUTE
    ON OBJECT::[dbo].[UTCToLocalTime] TO [OMSRole]
    AS [dbo];


GO
GRANT EXECUTE
    ON OBJECT::[dbo].[UTCToLocalTime] TO [OMSAdminRole]
    AS [dbo];


GO
GRANT EXECUTE
    ON OBJECT::[dbo].[LocalTimeToUTC] TO [OMSRole]
    AS [dbo];


GO
GRANT EXECUTE
    ON OBJECT::[dbo].[LocalTimeToUTC] TO [OMSAdminRole]
    AS [dbo];


GO
GRANT EXECUTE
    ON OBJECT::[dbo].[RemoveIllegalXMLCharacters] TO [OMSRole]
    AS [dbo];


GO
GRANT EXECUTE
    ON OBJECT::[dbo].[RemoveIllegalXMLCharacters] TO [OMSAdminRole]
    AS [dbo];


