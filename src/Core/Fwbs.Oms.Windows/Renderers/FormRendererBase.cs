using System;
using System.Collections;
using System.Data;
using System.Diagnostics;
using System.Drawing;
using System.IO;
using System.Reflection;
using System.Runtime.Serialization.Formatters.Binary;
using System.Windows.Forms;
using FWBS.Common;
using FWBS.Common.UI;
using FWBS.Common.UI.Windows;
using FWBS.OMS.UI.Windows.Design;

namespace FWBS.OMS.UI.Windows
{
    /// <summary>
    /// 38000 Base abstract class for rendering database driven forms.
    /// </summary>
    public class FormRendererBase : System.Windows.Forms.UserControl, ISupportRightToLeft
	{
		#region Events

		/// <summary>
		/// An event that gets raised before the controls are about to re-render.
		/// </summary>
		public event System.ComponentModel.CancelEventHandler Rendering = null;

		/// <summary>
		/// An event that gets raised after the controls have rendered.
		/// </summary>
		public event EventHandler Rendered = null;

		/// <summary>
		/// An event that gets raised if one of the rendered controls value has changed
		/// or its changed event has been fired.
		/// </summary>
		public event EventHandler ValueChanged = null;

		#endregion

		#region Fields
		/// <summary>
		/// Hastable of Controls added the Enquiry Form
		/// </summary>
		private Hashtable _enquiryControls = null;

        /// <summary>
        /// Indicates whether whole Enquiry form should be scaled on rendering.
        /// If set to False, individual controls will only be repositioned and resized, but not scaled.
        /// </summary>
        private bool? _scaleWholeForm = null;

		/// <summary>
		/// Global tool tip object that is used for assigning and unassigning tooltips to controls on the form.
		/// </summary>
		protected System.Windows.Forms.ToolTip tp;
		public System.Windows.Forms.ErrorProvider req;
		public System.Windows.Forms.ErrorProvider err;

		/// <summary>
		/// Added by default by the visual studio designer.
		/// </summary>
		private System.ComponentModel.IContainer components;

		/// <summary>
		/// Main database driven data set that holds the rendering of header information.
		/// </summary>
		protected DataSet _lists = new DataSet("ENQUIRYFORM");

		/// <summary>
		/// Main database driven data table that holds the rendering of question / control information.
		/// </summary>
		protected DataTable _questions = new DataTable("QUESTIONS");

		/// <summary>
		/// Holds the non deleted questions.
		/// </summary>
		private DataView _questionsView = null;

		/// <summary>
		/// Reference to the first control in the list.  This can therefor be used to set focus
		/// to a control on each wizard page for example.
		/// </summary>
		protected Control _firstControl = null;

		/// <summary>
		/// Allows Shadow Properties such as Visible and Security Settings
		/// </summary>
		private bool _indesignmode = false;

        protected RequiredFieldRenderer _reqFieldRenderer;

		#endregion

		#region Constructors

		/// <summary>
		/// Initializing code generated by the designer.
		/// </summary>
		private void InitializeComponent()
		{
            this.components = new System.ComponentModel.Container();
            System.ComponentModel.ComponentResourceManager resources = new System.ComponentModel.ComponentResourceManager(typeof(FormRendererBase));
            this.req = new System.Windows.Forms.ErrorProvider(this.components);
            this.err = new System.Windows.Forms.ErrorProvider(this.components);
            this.tp = new System.Windows.Forms.ToolTip(this.components);
            ((System.ComponentModel.ISupportInitialize)(this.req)).BeginInit();
            ((System.ComponentModel.ISupportInitialize)(this.err)).BeginInit();
            this.SuspendLayout();
            // 
            // req
            // 
            this.req.BlinkStyle = System.Windows.Forms.ErrorBlinkStyle.NeverBlink;
            this.req.ContainerControl = this;
            this.req.Icon = ((System.Drawing.Icon)(resources.GetObject("req.Icon")));
            // 
            // err
            // 
            this.err.ContainerControl = this;
            this.err.Icon = ((System.Drawing.Icon)(resources.GetObject("err.Icon")));
            // 
            // FormRendererBase
            // 
            this.Font = new System.Drawing.Font("Segoe UI", 9F);
            this.Name = "FormRendererBase";
            this.SizeChanged += new System.EventHandler(this.FormRendererBase_SizeChanged);
            ((System.ComponentModel.ISupportInitialize)(this.req)).EndInit();
            ((System.ComponentModel.ISupportInitialize)(this.err)).EndInit();
            this.ResumeLayout(false);

		}
	
		public FormRendererBase ()
		{
			InitializeComponent();
            _reqFieldRenderer = new RequiredFieldRenderer(req);
        }

        protected override void Dispose(bool disposing)
        {
            try
            {
                if (disposing)
                {
                    if (components != null)
                    {
                        components.Dispose();
                    }
                }
            }
            finally
            {
                base.Dispose(disposing);
            }
        }

		#endregion

		#region Methods

		/// <summary>
		/// Redraws the little tag at the bottom right
		/// </summary>
		/// <param name="sender"></param>
		/// <param name="e"></param>
		private void FormRendererBase_SizeChanged(object sender, System.EventArgs e)
		{
			this.Invalidate();
		}

		/// <summary>
		/// Adds a new data table to the lists collection.  For instance, this could be used to 
		/// populate a combo box or list box.
		/// </summary>
		/// <param name="list">List table object.</param>
		public void AddList (DataTable list)
		{
			if (list.DataSet != null)
				_lists.Tables.Add(list.Clone());
			else
				_lists.Tables.Add(list);
		}

		/// <summary>
		/// Returns the an enquiry from IBasicEnquiryControl2 item by the field name it was given.
		/// If no control is found then return a null reference.
		/// </summary>
		/// <param name="controlName">Database field name / control name.</param>
		/// <returns>Control object.</returns>
		public IBasicEnquiryControl2 GetIBasicEnquiryControl2(string controlName)
		{
			return EnquiryControls[controlName.ToUpper()] as IBasicEnquiryControl2;
		}

		/// <summary>
		/// Returns the an enquiry from IBasicEnquiryControl2 item by the field name it was given.
		/// If no control is found then return a null reference.
		/// </summary>
		/// <param name="controlName">Database field name / control name.</param>
		/// <returns>Control object.</returns>
		public IBasicEnquiryControl2 GetIBasicEnquiryControl2(string controlName, EnquiryControlMissing action)
		{
			IBasicEnquiryControl2 value = GetIBasicEnquiryControl2(controlName);
			if (value == null && action == EnquiryControlMissing.Exception)
				throw new OMSException2("38003","Control named '%1%' is missing, name has changed or does not Support IBasicEnquiryControl2. Please contact Support.",new Exception(),false,controlName);
			else if (value == null && action == EnquiryControlMissing.Create)
				return new FWBS.Common.UI.Windows.eLabel2();
			return value;
		}


		/// <summary>
		/// Gets or Builds the enquiry control hash table which is used for fetching controls by name.
		/// </summary>
		protected Hashtable EnquiryControls
		{
			get
			{
				// Create an Index of Controls
				if (_enquiryControls == null)
				{
					_enquiryControls = new Hashtable();
				}
				if (_enquiryControls.Count == 0 || this.Controls.Count != _enquiryControls.Count)
				{
					foreach (Control e in this.Controls)
					{
						if (_enquiryControls.Contains(e.Name.ToUpper()))
							_enquiryControls[e.Name.ToUpper()] = e;
						else
							_enquiryControls.Add(e.Name.ToUpper(), e);
					}
				}
				return _enquiryControls;
			}
		}

        public void ClearEnquiryControls()
        {
            _enquiryControls = null;
        }

		protected bool InDesignMode
		{
			get
			{
				return _indesignmode;
			}
			set
			{
				_indesignmode = value;
			}
		}

		/// <summary>
		/// Returns the an enquiry from IListEnquiryControl item by the field name it was given.
		/// If no control is found then return a null reference.
		/// </summary>
		/// <param name="controlName">Database field name / control name.</param>
		/// <returns>Control object.</returns>
		public IListEnquiryControl GetIListEnquiryControl(string controlName)
		{
			return EnquiryControls[controlName.ToUpper()] as IListEnquiryControl;
		}
		
		/// <summary>
		/// Returns the an enquiry from control item by the Property name it was given.
		/// If no control is found then return a null reference.
		/// </summary>
		/// <param name="controlName">Database field name / control name.</param>
		/// <returns>Control object.</returns>
		public Control GetControlByProperty(string PropertyName)
		{
			DataView dtv = new DataView(_questions,"quProperty = '" + PropertyName + "'","",DataViewRowState.CurrentRows);
			if (dtv.Count > 0)
			{
				return EnquiryControls[Convert.ToString(dtv[0]["quName"]).ToUpper()] as Control;
			}
			else
				return null;
		}
			
		/// <summary>
		/// Returns the an enquiry from control item by the field name it was given.
		/// If no control is found then return a null reference.
		/// </summary>
		/// <param name="controlName">Database field name / control name.</param>
		/// <returns>Control object.</returns>
		public Control GetControl(string controlName)
		{
			return EnquiryControls[controlName.ToUpper()] as Control;
		}

		/// <summary>
		/// Returns the an enquiry from control item by the field name it was given.
		/// If no control is found then return a null reference.
		/// </summary>
		/// <param name="controlName">Database field name / control name.</param>
		/// <returns>Control object.</returns>
		public Control GetControl(string controlName, EnquiryControlMissing action)
		{
			Control value = GetControl(controlName);
			if (value == null && action == EnquiryControlMissing.Exception)
				throw new OMSException2("38001","Control named '%1%' is missing or the name has changed. Please contact Support.",new Exception(),false,controlName);
			if (value == null && action == EnquiryControlMissing.Create)
				return new Control();
			return value;
		}



		/// <summary>
		/// Returns the an enquiry from control settings based on the control passed.
		/// If no settings are found then return a null reference.
		/// </summary>
		/// <param name="control">Control object.</param>
		/// <returns>The settings of the rendered control in a row format.</returns>
		public DataRow GetSettings(Control control)
		{
			foreach (DataRowView rowview in _questionsView)
			{
				if (Convert.ToString(rowview["quname"]) == control.Name)
				{
					return rowview.Row;
				}
			}
			return null;
		}

		/// <summary>
		/// Returns the an enquiry from control settings based on the control passed.
		/// If no settings are found then return a null reference.
		/// </summary>
		/// <param name="string">Control Name.</param>
		/// <returns>The settings of the rendered control in a row format.</returns>
		public DataRow GetSettings(string controlname)
		{
			foreach (DataRowView rowview in _questionsView)
			{
				if (Convert.ToString(rowview["quname"]) == controlname)
				{
					return rowview.Row;
				}
			}
			return null;
		}

		/// <summary>
		/// Passes the focus to another control to update the underlying data source.
		/// The focus will return then be returned back to the original active control.
		/// </summary>
		public virtual void ReBind()
		{
			Control ctrl = this.ActiveControl;
			this.SelectNextControl(ctrl, true, false, true, true);
			this.ActiveControl = ctrl;
		}


		#endregion

		#region Rendering Methods
		public virtual void RenderControls(bool clearExisting)
		{
			RenderControls(clearExisting,true);
		}

		/// <summary>
		/// Iterates through the whole data set and renders each of the control / question items
		/// by creating the controls from scratch.  It also specifies whether the controls collection
		/// is tyo be wiped first.
		/// </summary>
		/// <param name="clearExisting">Clears all exisisting controls when set to true.</param>
		public virtual void RenderControls(bool clearExisting, bool visible)
		{
			System.ComponentModel.CancelEventArgs cancel = new System.ComponentModel.CancelEventArgs(false);
			OnRendering(cancel);
			if (cancel.Cancel) return;

            _scaleWholeForm = (this.AutoScaleMode == AutoScaleMode.None) ? null : (bool?)clearExisting;
            //Stop any events from being fired during the render.
            this.SuspendLayout();
			this.Visible = false;
            if (_scaleWholeForm == true)
            {
                this.AutoScaleMode = AutoScaleMode.Dpi;
                this.AutoScaleDimensions = new SizeF(96F, 96F);
            }

            _firstControl = null;

			//Clears all existing controls so that the new rendering can occur.
			if (clearExisting) 
			{
                _enquiryControls = null;
                Global.RemoveAndDisposeControls(this);
			}

			//Filter all the deleted rows out of the rendering procedure by using a data view.
			SetupQuestionsView();

			//Loop throught each data row and call ther per control render method.
			//If the control already exists then pass a reference to this method.
			//If the control does not exist then the per control render methos will
			//create the control.
			foreach (DataRowView rowview in _questionsView)
			{
				DataRow row = rowview.Row;

				try
				{			
					Control ctrl = null;

					foreach (Control existing in this.Controls)
					{
						if (existing.Name == row["quname"].ToString())
						{
							ctrl = existing;
							break;
						}
					}			

					RenderControl(ref ctrl, row);

					if (row["qutaborder"] != DBNull.Value)
						ctrl.TabIndex = (int)row["qutaborder"];
						
				}
				catch(Exception ex)
				{
					ErrorBox.Show(ParentForm, ex);
				}

			}

			this.Visible = visible;
			this.ResumeLayout(!_scaleWholeForm.GetValueOrDefault());
            if (_scaleWholeForm == true)
            {
                this.AutoScaleDimensions = SizeF.Empty;
                this.AutoScaleMode = AutoScaleMode.Inherit;
            }
            _scaleWholeForm = null;

            OnRendered();

            if (_firstControl != null) 
			{
				_firstControl.Focus();
			}
		}

		/// <summary>
		/// Iterates through the whole data set and renders each of the control / question items
		/// by creating the controls from scratch.
		/// </summary>
		public virtual void RenderControls()
		{
			RenderControls(false);
		}


		/// <summary>
		/// Renders an existing specific control by passing the reference to it.
		/// </summary>
		/// <param name="ctrl">Control object to be modified / rendered.</param>
		public void RenderControl (ref Control ctrl)
		{
			SetupQuestionsView();

			foreach (DataRowView rowview in _questionsView)
			{
				DataRow row = rowview.Row;
				if (ctrl.Name == row["quname"].ToString())
				{
					RenderControl(ref ctrl, row);
					break;
				}
			}
		}

        public void RenderControl(string name)
        {
            if (String.IsNullOrEmpty(name))
                return;

            if (!this.Controls.ContainsKey(name))
                return;

            Control ctrl = this.Controls[name];

            RenderControl(ref ctrl);

        }
		/// <summary>
		/// Filters out all of the deleted questions.
		/// </summary>
		private void SetupQuestionsView()
		{
			if (_questionsView == null || _questionsView.Table != _questions)
			{
				_questionsView = new DataView(_questions);
			}
			_questionsView.RowStateFilter = DataViewRowState.OriginalRows;
			_questionsView.RowStateFilter = DataViewRowState.CurrentRows;
			try
			{
				if (_questionsView.Table.Columns.Contains("quOrder"))
                    _questionsView.Sort = "quOrder";
			}
			catch{}
		}

		/// <summary>
		/// Renders a control based on its raw question data.
		/// </summary>
		/// <param name="settings">Raw data row which holds the parameters of the render.</param>
		public void RenderControl (DataRow settings)
		{
			Control ct = null;
			foreach (Control ctrl in Controls)
			{
				if (settings["quname"].ToString() == ctrl.Name)
				{
					ct = ctrl;
					RenderControl(ref ct, settings);
					break;
				}
			}
		}

		/// <summary>
		/// Renders a control per property setting.
		/// </summary>
		/// <param name="ctrl">Control to modify.</param>
		/// <param name="settings">Settings data row object, matching to the control.</param>
		/// <param name="property">Individual property to change.</param>
		public virtual void RenderControl (ref Control ctrl, DataRow settings, string property)
		{
			if (_questions.Columns.Contains(property))
			{
				switch(property.ToLower())
				{
					case "qucontrol":
						if (ctrl != null)
						{
							ctrl.Dispose();
							ctrl = null;
						}
						RenderControl(ref ctrl, settings);
						break;
					case "quctrlid":
					{
						DataView vw = new DataView(_lists.Tables["CONTROLS"]);
						vw.RowFilter = "ctrlid = " + settings[property].ToString().Replace("'", "''");
						if (vw.Count > 0)
						{
							settings["qucontrol"] = vw[0]["ctrlwintype"].ToString();
							goto case "qucontrol";
						}
					}
						break;
					case "quname":
						if (_lists.Tables.Contains("DATA"))
						{
							if (_lists.Tables["DATA"].Columns.Contains(ctrl.Name))
							{
								_lists.Tables["DATA"].Columns[ctrl.Name].ColumnName = settings[property].ToString();
							}
							else
							{
								_lists.Tables["DATA"].Columns.Add(ctrl.Name).ColumnName = ctrl.Name;
							}
						}
						ctrl.Name = settings[property].ToString();
						break;
					case "moveboat":

						int x = (int)settings["quX"];
						int y = (int)settings["quY"];
			
						ctrl.RightToLeft = this.RightToLeft;	
			
                        // 2. Move Boat
                        MoveBoat(ctrl,(int)settings["qux"],(int)settings["quY"]);

						// 3. Set Size
						ctrl.Width = ConvertUnits((int)settings["quwidth"]);
						ctrl.Height = ConvertUnits((int)settings["quheight"]);

						// Anchoring or Docking
                        SetAnchorOrDocking(ctrl, settings);
						break;
					case "quanchor":
						goto case "moveboat";
					case "quwidth":
						goto case "moveboat";
					case "quheight":
						goto case "moveboat";
					case "qux":
						goto case "moveboat";
					case "quy":
						goto case "moveboat";
					case "qudesc":
						ctrl.Text = settings[property].ToString();
						break;
					case "qurequired":
						if  ((bool)settings["qurequired"])
						{
                            if (ctrl is IUsesRequiredStars)
                                ((IUsesRequiredStars)ctrl).RequiredIconsOn(true);
                            else
                            {
                                _reqFieldRenderer.MarkRequiredControl(ctrl);
                            }
						
						}
						else
						{
							if(ctrl is IUsesRequiredStars)
								((IUsesRequiredStars)ctrl).RequiredIconsOn(false);
                            else
                                req.SetError(ctrl, "");
                        }
						break;
					case "qureadonly":
						if (ctrl is IBasicEnquiryControl2)
							((IBasicEnquiryControl2)ctrl).ReadOnly = (bool)settings[property];
						break;
					case "qucaptionwidth":
						if (ctrl is IBasicEnquiryControl2)
							((IBasicEnquiryControl2)ctrl).CaptionWidth = (int)settings[property];
						break;
					case "quhelp":
						tp.SetToolTip(ctrl,  settings[property].ToString());
						break;
					case "qumaxlength":
						if (ctrl is ITextEditorEnquiryControl)
							((ITextEditorEnquiryControl)ctrl).MaxLength = (int)settings[property];
						break;
					case "qudatalist":
						if (_lists.Tables.Contains(settings[property].ToString()))
						{
							if (ctrl is IListEnquiryControl)
								((IListEnquiryControl)ctrl).AddItem(_lists.Tables[settings[property].ToString()].Copy());
						}
						break;
					case "quhidden":
                        ctrl.Visible = !(bool)settings[property];
						break;
					case "qutaborder":
						ctrl.TabStop = !(settings[property] == DBNull.Value);
						if (ctrl.TabStop) ctrl.TabIndex = (int)settings[property];
						break;
					case "qudefault":
						if (ctrl is IBasicEnquiryControl2)
							((IBasicEnquiryControl2)ctrl).Value = settings[property];
						break;
					case "qucommand":
						if (ctrl is ICommandEnquiryControl)
						{
							ICommandEnquiryControl command = (ICommandEnquiryControl)ctrl;
							command.ExecuteCommand -= new EventHandler(this.CommandCapture);
							command.ExecuteCommand += new EventHandler(this.CommandCapture);
							if (SQLRoutines.IsNullString(settings["qucommand"]) == false)
							{
								command.SetCommand(true);
								if (command.CommandButton != null)
									tp.SetToolTip(command.CommandButton, Convert.ToString(settings["qucmdhelp"]));
							}
							else
							{
								command.ExecuteCommand -= new EventHandler(this.CommandCapture);
								command.SetCommand(false);
							}						
						}
						break;
					case "qucasing":
						if (ctrl is ICharacterCasingControl)
						{
							((ICharacterCasingControl)ctrl).Casing = (CharacterCasing)ConvertDef.ToEnum(Convert.ToString(settings["qucasing"]), CharacterCasing.Normal);
						}
						break;
					case "quformat":
						if (ctrl is IFormatEnquiryControl)
						{
							((IFormatEnquiryControl)ctrl).Format = Convert.ToString(settings["quformat"]);
						}
						break;
					case "qucmdmethod":
						goto case "qucommand";
					case "qucmdparameters":
						goto case "qucommand";
					case "qucmdhelp":
						goto case "qucommand";
					case "qucustom":
					{
						byte [] bytes = (byte [])settings[property];
						MemoryStream strm = new MemoryStream(bytes, 0, bytes.Length);
						BinaryFormatter bf = new BinaryFormatter();
						bf.Binder = new DeserializationBinder();
						try
						{
							object obj = bf.Deserialize(strm);
							if (obj is ICollection)
							{
								ICollection proplist = (ICollection)obj;
								Type type = ctrl.GetType();
								foreach (DictionaryEntry prop in proplist)
								{
									//Ignore any invalid entries.
									try
									{
										Trace.WriteLineIf(Global.LogSwitch.TraceVerbose, "WUI.a: PROP: " + prop.Key.ToString(), Global.LogSwitch.DisplayName);
										type.InvokeMember(prop.Key.ToString(), BindingFlags.Public | BindingFlags.Instance | BindingFlags.SetProperty, null, ctrl, new object[]{prop.Value});
									}
									catch{}
								}
							}
							obj = null;
						}
						catch (Exception ex)
						{
							ErrorBox.Show(ParentForm, new Exception(ctrl.Name + ": " + ex.Message,ex));
						}
						finally
						{
							strm.Dispose();
							bf = null;
							bytes = null;
						}
					}
					break;
				}
			}
		}


		/// <summary>
		/// Renders a singular control based on the settings passed.  If a null reference to a control
		/// is passed then the controls will be created dependent on a valid control type.
		/// </summary>
		/// <param name="ctrl">Control object if any.</param>
		/// <param name="settings">Controls equivalent / matching settings data row object.</param>
		public virtual void RenderControl(ref Control ctrl, DataRow settings)
		{
				
			System.Text.StringBuilder sbDebug = new System.Text.StringBuilder();
			if (ctrl == null)
			{
                //
                // look at the assembly break apart and then decide to run from alternative path

                string theassembly = "";
                if (settings.Table.Columns.Contains("quAssembly"))
                    theassembly = Convert.ToString(settings["quAssembly"]);
                string thetype = settings["qucontrol"].ToString();

                Type ctrlType = null;
                try{ctrlType = Global.CreateType(thetype, theassembly);}
                catch {}

                if (ctrlType == null) ctrlType = typeof(eLabel2);

				//Get the default constructor with no arguments.
				ConstructorInfo ctrlConst = ctrlType.GetConstructor(Type.EmptyTypes);

				//Invoke the constructor, to create the control.
				ctrl = (Control)ctrlConst.Invoke(null);

				//Give the control the same name as the field.
				ctrl.Name = settings["quname"].ToString();
				sbDebug.Append("WUI.b (Name=");
				sbDebug.Append(ctrl.Name);
				sbDebug.Append(",");

			}

			//*************************************************
			//Control specific property settings.
			//*************************************************
			//Position the control keeping in account the RightToLeft setting.
			ctrl.Visible = false;	

			int x = (int)settings["quX"];
			int y = (int)settings["quY"];
			
			ctrl.RightToLeft = this.RightToLeft;

            // 3. Set Size of Ship
            if (settings["quwidth"] != DBNull.Value && settings["quHeight"] != DBNull.Value)
                ctrl.Size = ConvertUnits(new Size((int)settings["quwidth"], (int)settings["quHeight"]));
            sbDebug.Append(",Size=");
            sbDebug.Append(ctrl.Size.ToString());

            
			// 2. Move Boat
            MoveBoat(ctrl, x, y);
			sbDebug.Append("Location=");
			sbDebug.Append(ctrl.Location.ToString());

            // Anchoring or Docking
            SetAnchorOrDocking(ctrl, settings);


			ctrl.Text =(string)settings["qudesc"];

            if (settings["qutaborder"] != DBNull.Value)
            {
                ctrl.TabIndex = (int)settings["qutaborder"];
                ctrl.TabStop = true;
            }
            
            sbDebug.Append(",TabIndex=");
			sbDebug.Append(ctrl.TabIndex.ToString());


			
			//Set any extra custom properties exposed by the control by using the
			//controls reflected properties.
			if (settings.Table.Columns.Contains("qufilter") && Convert.ToString(settings["qufilter"]).IndexOf("<custom") > 0)
			{
				ConfigSetting cfg = new ConfigSetting(settings,"qufilter");
				//Count the number of parameters to be used.
				cfg.Current = "custom";
				int cnt = cfg.DocCurrent.Attributes.Count;

				//Loop through each of the parameters,
				for (int ctr = 0; ctr < cnt; ctr++)
				{
					//Get the name of the control to filter.
					string propname = cfg.DocCurrent.Attributes[ctr].Name;
					//Get the field name of the result set within the control being filtered.
					string propvalue = cfg.GetString(propname,""); 			
					object val = null;
					
					Type t = ctrl.GetType();
					System.Reflection.PropertyInfo prop = t.GetProperty(propname);
					if (prop != null)
					{
                        object[] attrs = prop.PropertyType.GetCustomAttributes(typeof(System.ComponentModel.TypeConverterAttribute), true);
					
						if (attrs.Length > 0)
						{
							System.ComponentModel.TypeConverterAttribute typeconv = (System.ComponentModel.TypeConverterAttribute)attrs[0];
                            Type tct = Session.CurrentSession.TypeManager.Load(typeconv.ConverterTypeName);
							System.ComponentModel.TypeConverter conv = (System.ComponentModel.TypeConverter)tct.InvokeMember("", System.Reflection.BindingFlags.CreateInstance, null, null, null);

                            if (conv is CodeLookupDisplayConverter)
                                val = new CodeLookupDisplay("ENQQUESTCUETXT") { Code = propvalue};
                            else if (conv.CanConvertFrom(typeof(string)))
								val = conv.ConvertFromInvariantString(propvalue);
							else
								val = DBNull.Value;
						}
						else
							val = propvalue;
					
						try
						{
							if (val != DBNull.Value)
							{
								if (prop.PropertyType.BaseType == typeof(System.Enum))
									prop.SetValue(ctrl, Enum.Parse(prop.PropertyType,propvalue,true), null);
								else
									prop.SetValue(ctrl, Convert.ChangeType(val, prop.PropertyType, System.Globalization.CultureInfo.InvariantCulture), null);
							}
						}
						catch{}
					}
				}
			}
			else if (settings["qucustom"] != DBNull.Value)
			{
				//Set any extra custom properties exposed by the control by using the
				//controls reflected properties.
				byte [] bytes = (byte [])settings["qucustom"];
				MemoryStream strm = new MemoryStream(bytes, 0, bytes.Length);
				BinaryFormatter bf = new BinaryFormatter();
				bf.Binder = new DeserializationBinder();
				try
				{
					object obj = null;
					try
					{
						obj = bf.Deserialize(strm);
					}
					catch (Exception ex)
					{
						Trace.WriteLineIf(Global.LogSwitch.TraceVerbose, "Exception : " + ctrl.Name + " : " + ex.Message, Global.LogSwitch.DisplayName);
						Console.WriteLine(ctrl.Name  + " - " + ex.Message);
					}
					if ((obj != null) && (obj is ICollection))
					{
						ICollection proplist = (ICollection)obj;
						Type type = ctrl.GetType();
						foreach (DictionaryEntry prop in proplist)
						{
							//Ignore any invalid entries.
							try
							{
								Trace.WriteLineIf(Global.LogSwitch.TraceVerbose, "WUI.a: PROP: " + prop.Key.ToString(), Global.LogSwitch.DisplayName);
								type.InvokeMember(prop.Key.ToString(), BindingFlags.Public | BindingFlags.Instance | BindingFlags.SetProperty, null, ctrl, new object[]{prop.Value});
							}
							catch (Exception ex)
							{
								Console.WriteLine(ctrl.Name  + " - " + ex.Message);
							}
						}
					}
					obj = null;
				}
				catch (Exception ex)
				{
					ErrorBox.Show(ParentForm, new Exception(ctrl.Name + ": " + ex.Message,ex));
				}
				finally
				{
					strm.Dispose();
					bf = null;
					bytes = null;
				}
			}

			sbDebug.Append(",Size=");
			sbDebug.Append(ctrl.Size.ToString());

			//*****************************************************
			//IListEnquiryControl specific property settings.
			//*****************************************************
			if (ctrl is	IListEnquiryControl)
			{
				if (_lists.Tables.Contains(settings["qudatalist"].ToString()))
				{
					((IListEnquiryControl)ctrl).AddItem(_lists.Tables[settings["qudatalist"].ToString()].Copy());
					sbDebug.Append(",DataSource=");
					sbDebug.Append(_lists.Tables[settings["qudatalist"].ToString()]);
				}
			}

			//*************************************************
			//IBasicEnquiryControl specific property settings.
			//*************************************************
			if (ctrl is IBasicEnquiryControl2)
			{
				IBasicEnquiryControl2 basic = (IBasicEnquiryControl2)ctrl;

				basic.ActiveChanged -= new EventHandler(this.OnValueChanged);
				basic.ActiveChanged += new EventHandler(this.OnValueChanged);
				
				basic.Required = (bool)settings["quRequired"];
				sbDebug.Append(",Required=");
				sbDebug.Append(basic.Required.ToString());
					
				basic.ReadOnly = (bool)settings["qureadonly"];
				sbDebug.Append(",ReadOnly=");
				sbDebug.Append(basic.ReadOnly.ToString());

				basic.CaptionWidth = (int)settings["qucaptionwidth"];
				sbDebug.Append(",CaptionWidth=");
				sbDebug.Append(basic.CaptionWidth.ToString());

                if (SQLRoutines.IsNullString(settings["quHelp"]) == false)
                {
                    IOverrideTooltip i = ctrl as IOverrideTooltip;
                    if (i != null)
                    {
                        tp.SetToolTip(i.ToolTipControl, settings["quHelp"].ToString());
                    }
                    else
                    {
                        tp.SetToolTip(ctrl, settings["quHelp"].ToString());
                    }
                }
			}


			//*****************************************************
			//ITextEditorEnquiryControl specific property settings.
			//*****************************************************
			if (ctrl is ITextEditorEnquiryControl)
			{
				((ITextEditorEnquiryControl)ctrl).MaxLength = (int)settings["qumaxlength"];
				sbDebug.Append(",MaxLength=");
				sbDebug.Append(((ITextEditorEnquiryControl)ctrl).MaxLength.ToString());
			}


			//*****************************************************
			//ICharacterCasingControl specific property settings.
			//*****************************************************
			if (ctrl is ICharacterCasingControl)
			{
				((ICharacterCasingControl)ctrl).Casing = (CharacterCasing)Common.ConvertDef.ToEnum(Convert.ToString(settings["qucasing"]), CharacterCasing.Normal);
			}

			//*****************************************************
			//IFormatEnquiryControl specific property settings.
			//*****************************************************
			if (ctrl is IFormatEnquiryControl)
			{
				((IFormatEnquiryControl)ctrl).Format = Convert.ToString(settings["quformat"]);
			}

			//*************************************************
			//ICommandEnquiryControl specific property settings.
			//*************************************************
			if (ctrl is ICommandEnquiryControl)
			{
				ICommandEnquiryControl command = (ICommandEnquiryControl)ctrl;
				command.ExecuteCommand -= new EventHandler(this.CommandCapture);
				command.ExecuteCommand += new EventHandler(this.CommandCapture);
				if (SQLRoutines.IsNullString(settings["qucmdmethod"]) == false)
				{
					command.SetCommand(true);
					if (command.CommandButton != null)
						tp.SetToolTip(command.CommandButton, Convert.ToString(settings["qucmdhelp"]));
				}
				else
				{
					command.ExecuteCommand -= new EventHandler(this.CommandCapture);
					command.SetCommand(false);
				}
			}

			if(ctrl is IUsesRequiredStars)
			{
				((IUsesRequiredStars)ctrl).RequiredIconsOn(false);
				((IUsesRequiredStars)ctrl).ErrorIconsOn(false);
			}
			else
			{
				//Reset any errors.
				err.SetError(ctrl, "");
                //Reset any required errors.
                req.SetError(ctrl, "");
            }

			//Decide whether to show the control, and align the required error provider control
			//depending on the current RightToLeft setting.
			if (_indesignmode == false)
			{
				if ((bool)settings["quHidden"])
				{
					ctrl.Visible = false;
					sbDebug.Append(",Hidden=True");
				}
				else
				{
                    ctrl.Visible = true;

                    if (ctrl is IUsesRequiredStars)
                    { }
                    else
                    {
                        if (this.RightToLeft == RightToLeft.Yes)
                            req.SetIconAlignment(ctrl, ErrorIconAlignment.MiddleLeft);
                        else
                            req.SetIconAlignment(ctrl, ErrorIconAlignment.MiddleRight);
                    }

                    if  ((bool)settings["qurequired"]) 
					{
                        if (ctrl is IUsesRequiredStars)
                        {
                            ((IUsesRequiredStars)ctrl).RequiredIconsOn(true);
                        }
                        else
                        {
                            _reqFieldRenderer.MarkRequiredControl(ctrl);
                        }
					}
					try
					{
						string edtrole = Convert.ToString(settings["quEditableRole"]);
						string viwrole = Convert.ToString(settings["quVisibleRole"]);
						if (edtrole != "" || viwrole != "")
						{
							if (edtrole != "" && FWBS.OMS.Session.CurrentSession.CurrentUser.IsInRoles(edtrole)==false)
							{
								if (ctrl is IBasicEnquiryControl2)
									((IBasicEnquiryControl2)ctrl).ReadOnly = true;
								else
									ctrl.Enabled = false;
							}
							if (viwrole != "" && FWBS.OMS.Session.CurrentSession.CurrentUser.IsInRoles(viwrole)==false)
								ctrl.Visible = false;
						}
					}
					catch
					{}

				}
			}
			else
			{
				ctrl.Visible = true;
			}


			Trace.WriteLineIf(Global.LogSwitch.TraceVerbose, sbDebug.ToString(), Global.LogSwitch.DisplayName);

			if (ctrl.Parent == null)
			{
				//Add the control to the collection of this form.
				this.Controls.Add(ctrl);

                if (this.RightToLeft == System.Windows.Forms.RightToLeft.Yes)
                {
                    SwitchAnchorRTL(ctrl, settings);
                    var isrtl = ctrl as ISupportRightToLeft;
                    if (isrtl == null)
                    {
                        foreach (Control item in ctrl.Controls)
                        {
                            Global.RightToLeftControlConverter(item, ParentForm);
                        }
                    }
                    else
                    {
                        isrtl.SetRTL(ParentForm);
                    }
                }

                if (settings["quwidth"] != DBNull.Value && settings["quHeight"] != DBNull.Value)
                    ctrl.Size = ConvertUnits(new Size((int)settings["quwidth"], (int)settings["quHeight"]));
                
                ctrl.BringToFront();
			}
		}

        protected void SetAnchorOrDocking(Control ctrl, DataRow settings)
        {
            string ancset = Convert.ToString(settings["quanchor"]);
            if (string.IsNullOrEmpty(ancset))
                return;

            AnchorStyles an = AnchorStyles.None;
            DockStyle ds = DockStyle.None;
            if (ancset.IndexOf("DL") > -1)
            {
                if (this.RightToLeft == System.Windows.Forms.RightToLeft.Yes)
                    ds = DockStyle.Right;
                else
                    ds = DockStyle.Left;
            }
            else if (ancset.IndexOf("DT") > -1)
                ds = DockStyle.Top;
            else if (ancset.IndexOf("DR") > -1)
            {
                if (this.RightToLeft == System.Windows.Forms.RightToLeft.Yes)
                    ds = DockStyle.Left;
                else
                    ds = DockStyle.Right;
            }
            else if (ancset.IndexOf("DB") > -1)
                ds = DockStyle.Bottom;
            else if (ancset.IndexOf("DF") > -1)
                ds = DockStyle.Fill;
            else
            {
                if (ancset.IndexOf("L") > -1)
                {
                    if (this.RightToLeft == System.Windows.Forms.RightToLeft.Yes)
                        an = an | AnchorStyles.Right;
                    else
                        an = an | AnchorStyles.Left;
                }
                if (ancset.IndexOf("T") > -1)
                    an = an | AnchorStyles.Top;
                if (ancset.IndexOf("R") > -1)
                {
                    if (this.RightToLeft == System.Windows.Forms.RightToLeft.Yes)
                        an = an | AnchorStyles.Left;
                    else
                        an = an | AnchorStyles.Right;
                }
                if (ancset.IndexOf("B") > -1)
                    an = an | AnchorStyles.Bottom;
            }
            if (an != AnchorStyles.None)
                ctrl.Anchor = an;
            if (ds != DockStyle.None)
                ctrl.Dock = ds;

        }

        protected void SwitchAnchorRTL(Control ctrl, DataRow settings)
        {
            string ancset = Convert.ToString(settings["quanchor"]);
            if (!string.IsNullOrEmpty(ancset))
                return;

            if (ctrl.Dock != DockStyle.None)
                return;

            var an = ctrl.Anchor;
            if (this.RightToLeft == System.Windows.Forms.RightToLeft.Yes)
            {
                an -= AnchorStyles.Left;
                an |= AnchorStyles.Right;
            }
            ctrl.Anchor = an;
        }

        protected void MoveBoat(Control ctrl, int x, int y)
        {
            if (this.RightToLeft == System.Windows.Forms.RightToLeft.Yes)
            {
                ctrl.Location = new System.Drawing.Point(this.Width - ctrl.Width - ConvertUnits(x), ConvertUnits(y));
            }
            else
            {
                ctrl.Location = new Point(ConvertUnits(x), ConvertUnits(y));
            }
        }

        protected int ConvertUnits(int value)
        {
            return _scaleWholeForm.GetValueOrDefault(true) ? value : LogicalToDeviceUnits(value);
        }

        protected Size ConvertUnits(Size value)
        {
            return _scaleWholeForm.GetValueOrDefault(true) ? value : LogicalToDeviceUnits(value);
        }

        /// <summary>
        /// Removes a control from the rendered questions.
        /// </summary>
        /// <param name="ctrl">Reference to the control to be removed.</param>
        public DataRow RemoveControl(ref Control ctrl)
		{
			SetupQuestionsView();
			if (ctrl != null)
			{
				foreach (DataRowView rowview in _questionsView)
				{
					DataRow row = rowview.Row;
					if (ctrl.Name == row["quname"].ToString())
					{
						row.Delete();
						ctrl.Dispose();
						ctrl = null;
						return row;
					}

				}
			}
			return null;
		}


		/// <summary>
		/// Removes a control from the rendered list by specifying the matching question settings.
		/// </summary>
		/// <param name="settings">Data row of the question to be removed.</param>
		public void RemoveControl(DataRow settings)
		{
			Control ct = null;
			foreach (Control ctrl in Controls)
			{
				if (settings["quname"].ToString() == ctrl.Name)
				{
					ct = ctrl;
					settings.Delete();
					ct.Dispose();
					ct = null;
					break;
				}
			}
		}

		#endregion

		#region Control Captured Events


		/// <summary>
		/// Captures the command event on each of the enquiry controls which implement the ICommandEnquiryControl interface.
		/// This method will be passed information to execute a method in a specified object.
		/// </summary>
		/// <param name="sender">Calling control object.</param>
		/// <param name="e">Empty event arguments.</param>
		protected virtual void CommandCapture(object sender, EventArgs e)
		{
		}


		#endregion

		#region Event Methods

		/// <summary>
		/// Forces the Rendering event to be raised.
		/// </summary>
		protected void OnRendering(System.ComponentModel.CancelEventArgs e)
		{
            if (Rendering != null)
				Rendering(this, e);
		}

		/// <summary>
		/// Forces the Rendered event to be raised.
		/// </summary>
		protected void OnRendered()
		{
            if (Rendered != null)
				Rendered(this, EventArgs.Empty);

	    }

		/// <summary>
		/// This method gets called when the changed event is fired.
		/// </summary>
		/// <param name="sender">Control instance that has called the method.</param>
		/// <param name="e">Event arguments passed by the control.</param>
		private void OnValueChanged(object sender, EventArgs e)
		{
			if (ValueChanged != null)
				ValueChanged(sender, e);
		}

		#endregion

		#region Static
		public static void ConvertQuestionsToV2()
		{
			EnquiryEngine.Enquiry enq = new FWBS.OMS.EnquiryEngine.Enquiry();
			DataTable dt = enq.ConvertToV2("FWBS Ltd © 2005");
			frmProgress prg = new frmProgress();
			prg.Label = "Converting Enquiry Questions to V2";
			prg.ProgressBar.Maximum = dt.Rows.Count;
			prg.ProgressBar.Value = 0;
			prg.Show();
			foreach (DataRow settings in dt.Rows)
			{
				prg.ProgressBar.Value++;
				Application.DoEvents();
				//Set any extra custom properties exposed by the control by using the
				//controls reflected properties.
				byte [] bytes = (byte [])settings["qucustom"];
				MemoryStream strm = new MemoryStream(bytes, 0, bytes.Length);
				BinaryFormatter bf = new BinaryFormatter();
				bf.Binder = new DeserializationBinder();
				try
				{
					object obj = null;
					try
					{
						obj = bf.Deserialize(strm);
					}
					catch
					{
					}
					if ((obj != null) && (obj is ICollection))
					{
						ICollection proplist = (ICollection)obj;
						string vn = "";
						FWBS.Common.ConfigSetting cfg = new FWBS.Common.ConfigSetting(settings,"qufilter");
						cfg.Current = "custom";

						foreach (DictionaryEntry prop in proplist)
						{
							//Ignore any invalid entries.
							try
							{
								try
								{
									Type t = prop.Value.GetType();
									object[] attrs = t.GetCustomAttributes(typeof(System.ComponentModel.TypeConverterAttribute), true);
									if (attrs.Length > 0)
									{
										System.ComponentModel.TypeConverterAttribute typeconv = (System.ComponentModel.TypeConverterAttribute)attrs[0];
                                        Type tct = Session.CurrentSession.TypeManager.Load(typeconv.ConverterTypeName);
										System.ComponentModel.TypeConverter conv = (System.ComponentModel.TypeConverter)tct.InvokeMember("", System.Reflection.BindingFlags.CreateInstance, null, null, null);
										vn = conv.ConvertToInvariantString(prop.Value);
									}
									else
									{
										vn = Convert.ToString(prop.Value, System.Globalization.CultureInfo.InvariantCulture);
									}								
									cfg.SetString(Convert.ToString(prop.Key),vn);
								}
								catch
								{
								}
							}
							catch
							{
							}
						}
						cfg.Synchronise();
					}
					obj = null;
				}
				catch
				{
				}
				finally
				{
					strm.Dispose();
					bf = null;
					bytes = null;
				}
			}
			enq.ConvertToV2("FWBS Ltd © 2005",dt);
			prg.Close();
		}
		#endregion

        public void SetRTL(Form parentform)
        {
        }

        protected void SetRTLInternal()
        {
            foreach (Control item in this.Controls)
            {
                Global.RightToLeftControlConverter(item, null);
            }
        }
    }


	/// <summary>
	/// A class that will alter the expected version do that the serialsation / deserialisation
	/// performs without a hitch.
	/// </summary>
	internal sealed class DeserializationBinder : System.Runtime.Serialization.SerializationBinder 
	{
		public override Type BindToType(string assemblyName, string typeName) 
		{
            return Session.CurrentSession.TypeManager.Load(typeName);
		}
	}

}
