IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[sprIGOExportClients]') AND type = N'P ')
      DROP PROCEDURE [dbo].[sprIGOExportClients]
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[sprIGOExportFeeEarners]') AND type = N'P ')
      DROP PROCEDURE [dbo].[sprIGOExportFeeEarners]
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[sprIGOExportFinancials]') AND type = N'P ')
      DROP PROCEDURE [dbo].[sprIGOExportFinancials]
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[sprIGOExportMatters]') AND type = N'P ')
      DROP PROCEDURE [dbo].[sprIGOExportMatters]
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[sprIGOExportMatterTypes]') AND type = N'P ')
      DROP PROCEDURE [dbo].[sprIGOExportMatterTypes]
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[sprIGOExportTime]') AND type = N'P ')
      DROP PROCEDURE [dbo].[sprIGOExportTime]
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[sprIGOExportTimeActivity]') AND type = N'P ')
      DROP PROCEDURE [dbo].[sprIGOExportTimeActivity]
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[sprIGOExportUsers]') AND type = N'P ')
      DROP PROCEDURE [dbo].[sprIGOExportUsers]
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[sprIGOUpdateClients]') AND type = N'P ')
      DROP PROCEDURE [dbo].[sprIGOUpdateClients]
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[sprIGOUpdateMatters]') AND type = N'P ')
      DROP PROCEDURE [dbo].[sprIGOUpdateMatters]
GO

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------






CREATE   PROCEDURE [dbo].[sprIGOExportClients]
AS

IF  EXISTS (select * from dbo.sysobjects where id = object_id(N'[dbo].[sprIGOExportClients_CUSTOM]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
BEGIN
	EXEC sprIGOExportClients_CUSTOM
	RETURN
END

SET NOCOUNT ON

SELECT TOP 1000
	CL.clID AS clID 
	, CL.clNo AS ClientNo 
	, CL.clName AS ClientName 
	, 	-- This field is a sort field and may need to be taylored to customer requirements. For now we will use clSearch1
	 LEFT ( CL.clSearch1 , 50 )AS ClientKey 
	, CC.contRegCoName AS CompanyName 
	, 0 AS PartnerID
	, FEEEXTID AS FEEEARNERID
	, CI.contDOB AS DateOfBirth 
	, CI.contNINumber AS NINumber 
	, C.contSalut AS Salutation 
	, CI.contNOK AS NextOfKin 
	, CL.clTypeCode AS ClientType 
	, CL.clSource AS BusinessSource 
	, CL.clMarket AS Mailshot 
	, 0 AS TermsOfEngagement 
	, '' AS AssociatedClient 
	, 0 AS ConflictSearchDone 
	, '' AS ConflictingClients 
	, '' AS ConnectedClients 
	, 0 AS CreditControl 
	, 0 AS MoneyLaunderingChecked 
	, '' AS MoneyLaunderingNotes 
	, left(clName, 50) AS Addressee
	, CASE WHEN clDefaultAddress IS NULL THEN AD2.AddLine1 ELSE AD1.AddLine1 END AS AddressLine1 
	, CASE WHEN clDefaultAddress IS NULL THEN ltrim(left(coalesce(AD2.AddLine2, '') + ' ' + coalesce(AD2.AddLine3, ''), 50)) ELSE ltrim(left(coalesce(AD1.AddLine2, '') + ' ' + coalesce(AD1.AddLine3, ''), 50)) END AS AddressLine2 
	, CASE WHEN clDefaultAddress IS NULL THEN AD2.AddLine4 ELSE AD1.AddLine4 END AS Town 
	, CASE WHEN clDefaultAddress IS NULL THEN AD2.AddLine5 ELSE AD1.AddLine5 END AS County 
	, CASE WHEN clDefaultAddress IS NULL THEN AD2.AddPostCode ELSE AD1.AddPostCode END AS PostCode 
	, CN1.contNumber AS PhoneNo 
	, CN2.contNumber AS MobileNo 
	, CN3.contNumber AS FaxNo 
	, CE.contEmail AS EmailAddress 
	, CL.Created AS DateOpened

FROM
	( SELECT * FROM dbClient CL WHERE clExtID IS NULL AND CL.clNeedExport = 1) CL
INNER JOIN
	dbFeeEarner F ON F.feeusrID = CL.feeUsrID
LEFT JOIN
	dbContactCompany CC ON CC.contID = CL.clDefaultContact
LEFT JOIN
	dbContactIndividual CI ON CI.contID = CL.clDefaultContact
LEFT JOIN
	dbContact C ON C.contID = CL.clDefaultContact
LEFT JOIN
	dbAddress AD1 ON AD1.AddID = CL.clDefaultAddress
LEFT JOIN
	dbAddress AD2 ON AD2.AddID = C.contDefaultAddress
LEFT JOIN
	( SELECT contID , contNumber  FROM dbContactNumbers WHERE contCode = 'TELEPHONE' AND contExtraCode = 'HOME' AND contOrder = 0 AND contActive = 1  ) CN1 ON CN1.contID = C.contID
LEFT JOIN
	( SELECT contID , contNumber  FROM dbContactNumbers WHERE contCode = 'MOBILE' AND contExtraCode = 'HOME' AND contOrder = 0 AND contActive = 1  ) CN2 ON CN2.contID = C.contID
LEFT JOIN
	( SELECT contID , contNumber  FROM dbContactNumbers WHERE contCode = 'FAX' AND contExtraCode = 'HOME' AND contOrder = 0 AND contActive = 1  ) CN3 ON CN3.contID = C.contID
LEFT JOIN
	( SELECT contID , contEmail  FROM dbContactEmails WHERE contCode = 'HOME' AND contOrder = 0 AND contActive = 1  ) CE ON CE.contID = C.contID
WHERE 
	( IsNumeric ( CC.contRegNo ) = 1 OR coalesce(CC.contRegNo, '') = '' ) 
	AND COALESCE ( feeExtID , 0 ) != 0

GO

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


CREATE PROCEDURE [dbo].[sprIGOExportFeeEarners]
AS
SET NOCOUNT ON

SELECT 
	F.feeusrID AS FeeUsrID 
	, UPPER ( U.usrInits ) AS FeeEarnerCode 
	, U.usrFullName AS FeeEarnerName 
	, 0 AS Grade 
	, ( SELECT TOP 1 regTimeUnitValue FROM dbRegInfo ) AS MinsPerUnit 
	, 0 AS IsPartner 
	, 0 AS CostRate 
	, 0 AS ChargeRate 
	, 0 AS DailyTargetTime 
	, 0 AS DailyTargetValue 
	, U.usrAlias AS UserCode
	, B.brCode as BranchNo
	, F.feeExtID AS FEEEARNERID

FROM
	dbUser U 
JOIN
	dbFeeEarner F ON U.usrID = F.feeUsrID
JOIN
	dbBranch B on U.brid = B.brid
WHERE 
	COALESCE ( FEEEXTID , 0 ) = 0 




GO

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

CREATE PROCEDURE [dbo].[sprIGOExportFinancials] 
AS
SET NOCOUNT ON

IF  EXISTS (select * from dbo.sysobjects where id = object_id(N'[dbo].[sprIGOExportFinancials_CUSTOM]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
BEGIN
	EXEC sprIGOExportFinancials_CUSTOM
	RETURN
END

DECLARE @offset INT
SET @offset = DATEDIFF(HOUR, GetUTCDate(), GetDate())

SELECT
	FL.FinLogID as ID
	, CL.clNo AS ClientNo 
	, F.fileNo AS MatterNo 
	, DATEADD(HOUR,@offset, FL.finitemdate) AS PostingDate
	, 0 AS YearNo 
	, 0 AS PeriodNo 
	, PT.postAccCode as PostingType
--	, CASE PT.postCode
--		WHEN 'CLDEBIT' THEN PT.postAccCode
--		WHEN 'OFFDEBIT' THEN PT.postAccCode
--	END AS PostingType
	, U.USREXTID AS USERID
	, FEE.FEEEXTID as FEEEARNERID
	, FL.finTheirRef AS Reference
	, FL.finDesc AS Narrative 
	, 1 AS OtherTextType
	, FL.finPayName AS OtherText
	, FL.finValue AS NetValue
	, FL.finVAT AS VATValue
	, NULL AS Notes
	, AUTHORISED.usrExtID AS AUTHORISEDUSERID
	--, 'XXX' as BankSortCode Optional
	--, 'XXX' as BankAccountNo Optional
FROM
	dbFinancialLedger FL
JOIN
	dbpostingtype PT on PT.postid = FL.postid
JOIN
	dbFile F ON FL.fileID = F.fileID
JOIN
	dbClient CL ON F.clID = CL.clID
JOIN
	dbBranch br ON br.brID = F.brid
JOIN
	dbUser U ON U.usrID = FL.CreatedBy
INNER JOIN 
	dbFeeEarner FEE ON FEE.feeusrID = FL.finAuthByFeeID
INNER JOIN 
	dbUser AUTHORISED ON FL.finAuthByfeeID = AUTHORISED.USRID
AND	
	F.FileExtLinkID IS NOT NULL
WHERE
	FL.finNeedExport = 1 AND
	F.FILESTATUS != 'DEAD' AND
	FL.finExtID IS NULL AND
	COALESCE ( U.usrExtID , 0 ) != 0 AND 
	COALESCE ( FEE.feeExtID , 0 ) != 0 
--ORDER BY 
--	ec.ecPostingDate

GO

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

CREATE    PROCEDURE [dbo].[sprIGOExportMatters]
AS

SET NOCOUNT ON

IF  EXISTS (select * from dbo.sysobjects where id = object_id(N'[dbo].[sprIGOExportMatters_CUSTOM]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
BEGIN
	EXEC sprIGOExportMatters_CUSTOM
	RETURN
END

SELECT TOP 1000
	F.fileID AS FileID
	, B.brCode AS BranchNo
	, CL.clNo AS ClientNo
	, F.fileNo AS MatterNo
	, F.fileDesc AS MatterDescription
	, PART.FEEEXTID AS PartnerID
	, FEE.FEEEXTID AS FeeEarnerID
	, F.fileLACategory AS LegalAidCategory
	, CASE fileFundCode
		WHEN 'LEGALAID' THEN F.fileFundRef
		ELSE NULL
	END AS CertificateNo
	, CASE fileFundCode
		WHEN 'LEGALAID' THEN F.fileAgreementDate
	ELSE NULL
	END AS LegalAidDate 
	, FT.fileAccCode AS WorkTypeCode 
	, convert ( varchar (4000) , F.fileNotes  ) AS UserNotes 
	, F.Created AS DateOpened
	, fileDefOffBankCode AS OfficeBankNo
	, fileDefBankCode AS ClientBankNo
	, fileRatePerUnit AS ChargeRate
	, CASE WHEN fileFundCode = 'NOCHARGE' THEN 1 ELSE 0 END AS ZeroChargeRate
	, F.fileCreditLimit * F.fileWarningPerc /100 AS TotalCreditWarning
	, F.fileCreditLimit AS TotalCreditLimit
	, F.fileCreditLimit * F.fileWarningPerc /100 AS WIPCreditWarning
	, F.fileCreditLimit AS WIPCreditLimit
	, F.fileEstimate AS EstimatedCosts
	, F.fileFundCode as FUNDTYPE
	, NULL AS ALERT
	--,'XYZ' AS MatterKey --Optional
FROM
	dbClient CL
INNER JOIN
	dbFile F ON F.clID = CL.clID
INNER JOIN
	dbFeeEarner FEE ON FEE.feeusrID = F.filePrincipleID
INNER JOIN
	dbFeeEarner PART ON PART.feeusrID = F.fileResponsibleID
INNER JOIN
	dbFileType FT ON FT.typeCode = F.fileType
INNER JOIN 
	dbBranch B on F.brID = B.brid
WHERE
	IsNumeric ( FT.fileAccCode ) = 1
	AND IsNumeric ( F.fileNo) = 1
	AND COALESCE ( FEE.FEEEXTID , 0 ) != 0 
	AND COALESCE ( PART.FEEEXTID , 0 ) ! = 0 
	AND	F.fileNeedExport = 1
	AND F.fileExtlinkID IS NULL
	AND CL.clExtID IS NOT NULL
	AND F.fileStatus not in ('LIVEPREINST','LIVEAWAITACK')



GO

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

CREATE  PROCEDURE [dbo].[sprIGOExportMatterTypes]
AS
SET NOCOUNT ON

DECLARE @vSQL nvarchar(2000) , @vLinkedIndigoServer nvarchar(400)
SET @vLinkedIndigoServer = ( SELECT spData FROM dbSpecificData WHERE spLookup = 'INDIGOLNKSVR' )
SET @vSQL = '
SELECT 
      F.FileAccCode as WorkTypeCode ,
      LEFT ( ( SELECT TOP 1 dbo.GetCodeLookupDesc ( ''FILETYPE'' , TypeCode , ''{default}'' )  FROM dbFileType F2 WHERE F2.FileAccCode = F.FileACcCode ) , 50 ) as Description
FROM
      ( SELECT DISTINCT FileAccCode FROM dbFileType WHERE FileAccCode IS NOT NULL AND IsNumeric(FileAccCode) = 1) F
LEFT JOIN
      ' + @vLinkedIndigoServer + '.dbo.WorkTypes WT ON WT.WorkTypeCode = F.fileAccCode
WHERE
      WT.WorkTypeCode IS NULL'

EXEC ( @vSQL )



GO

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


CREATE   PROCEDURE [dbo].[sprIGOExportTime] 
AS
SET NOCOUNT ON

IF  EXISTS (select * from dbo.sysobjects where id = object_id(N'[dbo].[sprIGOExportTime_CUSTOM]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
BEGIN
	EXEC sprIGOExportTime_CUSTOM
	RETURN
END

SELECT
	T.ID as ID ,
	CL.clNo as ClientNo ,
	F.fileNo as MatterNo ,
	T.timeRecorded as PostingDate ,
	0 as YearNo ,
	0 as PeriodNo , 
	FEEEXTID as FeeEarnerID ,
	A.actAccCode as ActivityCode ,
	T.timeMins as Minutes ,
	0 as Quantity ,	
	T.timeUnits as Units ,
	0 as CostRate ,
	ROUND( T.TimeCost , 2 ) as CostValue ,
	0 as ChargeRate ,
	ROUND ( T.TimeCharge , 2 ) as ChargeValue ,
	T.timeDesc as Narrative ,
	T.timeRecorded as TimeStarted ,
	T.timeRecorded as TimeEnded
FROM
	dbTimeLedger T
INNER JOIN
	dbFile F ON T.fileID = F.fileID
INNER JOIN
	dbClient CL ON F.clID = CL.clID
INNER JOIN
	dbFeeEarner FEE ON FEE.FEEUSRID = T.feeUsrid 
INNER JOIN
	dbActivities A on A.actCode = T.timeActivityCode
WHERE
	Isnumeric ( A.actAccCode ) = 1
	AND T.timeTransferred = 0
	AND CL.ClExtID IS NOT NULL
	AND	F.FileExtLinkID IS NOT NULL
	AND COALESCE ( FEE.feeExtID , 0 ) ! = 0 
ORDER BY 
	T.Created

GO

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

CREATE PROCEDURE [dbo].[sprIGOExportTimeActivity]
AS
SET NOCOUNT ON

DECLARE @vSQL nvarchar(2000) , @vLinkedIndigoServer nvarchar(400)
SET @vLinkedIndigoServer = ( SELECT spData FROM dbSpecificData WHERE spLookup = 'INDIGOLNKSVR' )
SET @vSQL = '
SELECT
	A.actCode as ActivityCode ,
	LEFT ( dbo.GetCodeLookupDesc ( ''TIMEACTCODE'' , A.actCode , ''{default}'' ) , 50 ) as Description ,
	A.actChargeable as Chargeable ,
	0 as UseQuantity
FROM
	dbActivities A
LEFT JOIN
	' + @vLinkedIndigoServer + '.dbo.Activities AT ON AT.ActivityCode = A.actCode
WHERE
	IsNumeric(A.actCode) = 1
AND 
	AT.ActivityCode IS NULL'
EXEC ( @vSQL )



GO

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

CREATE PROCEDURE [dbo].[sprIGOExportUsers]
AS
SELECT 
	U.USRID as USRID
	, U.USRINITS as USERCODE
	, U.USRFULLNAME as USERFULLNAME
	, NULL AS FEEEARNERCODE --NEVER PASS THIS THROUGH AS THESE ARE USERS
	, U.USREXTID AS USERID
FROM
	dbUser U
WHERE
	COALESCE ( U.USREXTID , 0 ) = 0
	AND ( USRID > 0 OR USRID < -101 ) --REMOVE THE SYSTEM USERS



GO

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

CREATE   PROCEDURE [dbo].[sprIGOUpdateClients]
AS

SET NOCOUNT ON

IF  EXISTS (select * from dbo.sysobjects where id = object_id(N'[dbo].[sprIGOUpdateClients_CUSTOM]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
BEGIN
	EXEC sprIGOUpdateClients_CUSTOM
	RETURN
END

SELECT TOP 1000
	CL.clID AS clID 
	, CL.clNo AS ClientNo 
	, CL.clName AS ClientName 
	, -- This field is a sort field and may need to be taylored to customer requirements. For now we will use clName
	LEFT ( CL.clSearch1 , 50 )AS ClientKey 
	, CC.contRegCoName AS CompanyName 
	, 0 AS PartnerID
	, F.FEEEXTID AS FEEEARNERID
	, CI.contDOB AS DateOfBirth 
	, CI.contNINumber AS NINumber 
	, C.contSalut AS Salutation 
	, CI.contNOK AS NextOfKin 
	, CL.clTypeCode AS ClientType 
	, CL.clSource AS BusinessSource 
	, CL.clMarket AS Mailshot 
	, 0 AS TermsOfEngagement 
	, '' AS AssociatedClient 
	, 0 AS ConflictSearchDone 
	, '' AS ConflictingClients 
	, '' AS ConnectedClients 
	, 0 AS CreditControl 
	, 0 AS MoneyLaunderingChecked 
	, '' AS MoneyLaunderingNotes 
	, left(clName, 50) AS Addressee
	, CASE WHEN clDefaultAddress IS NULL THEN AD2.AddLine1 ELSE AD1.AddLine1 END AS AddressLine1 
	, CASE WHEN clDefaultAddress IS NULL THEN ltrim(left(coalesce(AD2.AddLine2, '') + ' ' + coalesce(AD2.AddLine3, ''), 50)) ELSE ltrim(left(coalesce(AD1.AddLine2, '') + ' ' + coalesce(AD1.AddLine3, ''), 50)) END AS AddressLine2 
	, CASE WHEN clDefaultAddress IS NULL THEN AD2.AddLine4 ELSE AD1.AddLine4 END AS Town 
	, CASE WHEN clDefaultAddress IS NULL THEN AD2.AddLine5 ELSE AD1.AddLine5 END AS County 
	, CASE WHEN clDefaultAddress IS NULL THEN AD2.AddPostCode ELSE AD1.AddPostCode END AS PostCode 
	, CN1.contNumber AS PhoneNo 
	, CN2.contNumber AS MobileNo 
	, CN3.contNumber AS FaxNo 
	, CE.contEmail AS EmailAddress 
	, CL.Created AS DateOpened
FROM
	( SELECT * FROM dbClient CL WHERE clExtID IS NOT NULL AND CL.clNeedExport = 1) CL
INNER JOIN
	dbFeeEarner F ON F.feeusrID = CL.feeUsrID
LEFT JOIN
	dbContactCompany CC ON CC.contID = CL.clDefaultContact
LEFT JOIN
	dbContactIndividual CI ON CI.contID = CL.clDefaultContact
LEFT JOIN
	dbContact C ON C.contID = CL.clDefaultContact
LEFT JOIN
	dbAddress AD1 ON AD1.AddID = CL.clDefaultAddress
LEFT JOIN
	dbAddress AD2 ON AD2.AddID = C.contDefaultAddress
LEFT JOIN
	( SELECT contID , contNumber  FROM dbContactNumbers WHERE contCode = 'TELEPHONE' AND contExtraCode = 'HOME' AND contOrder = 0 AND contActive = 1  ) CN1 ON CN1.contID = C.contID
LEFT JOIN
	( SELECT contID , contNumber  FROM dbContactNumbers WHERE contCode = 'MOBILE' AND contExtraCode = 'HOME' AND contOrder = 0 AND contActive = 1  ) CN2 ON CN2.contID = C.contID
LEFT JOIN
	( SELECT contID , contNumber  FROM dbContactNumbers WHERE contCode = 'FAX' AND contExtraCode = 'HOME' AND contOrder = 0 AND contActive = 1  ) CN3 ON CN3.contID = C.contID
LEFT JOIN
	( SELECT contID , contEmail  FROM dbContactEmails WHERE contCode = 'HOME' AND contOrder = 0 AND contActive = 1  ) CE ON CE.contID = C.contID
WHERE 
	COALESCE ( feeExtID , 0 ) != 0 
	AND ( IsNumeric ( CC.contRegNo ) = 1 OR coalesce(CC.contRegNo, '') = '' ) 



GO

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

CREATE    PROCEDURE [dbo].[sprIGOUpdateMatters]
AS
SET NOCOUNT ON

IF  EXISTS (select * from dbo.sysobjects where id = object_id(N'[dbo].[sprIGOUpdateMatters_CUSTOM]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
BEGIN
	EXEC sprIGOUpdateMatters_CUSTOM
	RETURN
END

SELECT 
	F.fileID AS FileID
	, B.brCode AS BranchNo
	, CL.clNo AS ClientNo 
	, F.fileNo AS MatterNo 
	, F.fileDesc AS MatterDescription 
	, PART.FEEEXTID AS PartnerID
	, FEE.FEEEXTID AS FeeEarnerID
	, F.fileLACategory AS LegalAidCategory 
	, CASE fileFundCode
		WHEN 'LEGALAID' THEN F.fileFundRef
	ELSE NULL
	END AS CertificateNo 
	, CASE fileFundCode
		WHEN 'LEGALAID' THEN F.fileAgreementDate 
	ELSE NULL
	END AS LegalAidDate 
	, FT.fileAccCode AS WorkTypeCode 
	, convert ( varchar (4000) , F.fileNotes  ) AS UserNotes
	, F.Created AS DateOpened
	, fileDefOffBankCode AS OfficeBankNo
	, fileDefBankCode AS ClientBankNo
	, fileRatePerUnit AS ChargeRate
	, CASE WHEN fileFundCode = 'NOCHARGE' THEN 1 ELSE 0 END AS ZeroChargeRate
	, F.fileCreditLimit * F.fileWarningPerc /100 AS TotalCreditWarning
	, F.fileCreditLimit AS TotalCreditLimit
	, F.fileCreditLimit * F.fileWarningPerc /100 AS WIPCreditWarning
	, F.fileCreditLimit AS WIPCreditLimit
	, F.fileEstimate AS EstimatedCosts
	, F.FILEFUNDCODE AS FUNDTYPE
	, NULL AS ALERT
	-- ,'XXX' as MatterKey Optional        

FROM
	dbClient CL
INNER JOIN
	dbFile F ON F.clID = CL.clID
INNER JOIN
	dbFeeEarner FEE ON FEE.feeusrID = F.filePrincipleID
INNER JOIN
	dbFeeEarner PART ON PART.feeusrID = F.fileResponsibleID
INNER JOIN
	dbFileType FT ON FT.typeCode = F.fileType
INNER JOIN 
	dbBranch B on F.brID = B.brid
WHERE
	IsNumeric ( FT.fileAccCode ) = 1
	AND IsNumeric ( F.fileNo) = 1
	AND COALESCE ( FEE.FEEEXTID , 0 ) != 0 
	AND COALESCE ( PART.FEEEXTID , 0 ) ! = 0 
	AND	F.fileNeedExport = 1
	AND F.fileExtlinkID IS NOT NULL
	AND CL.clExtID IS NOT NULL
	AND F.fileStatus not in ('LIVEPREINST','LIVEAWAITACK')


GO
